# Modul 3 Visualisasi Data

## Loading external data

Instead of typing the data in a local variable, which is only convenient for very small datasets, we can load data asynchronously from external files. The D3 built-in methods make it easy to load JSON, CSV, and other files.

Similar to JSON, CSV is a file format which is often used to exchange data. Each line in a CSV file represents a table row and as the name indicates, the values/columns are separated by a comma. The use of the right file format depends on the data - JSON should be used for hierarchical data and CSV is usually a proper way to store tabular data.

By calling D3 methods, such as d3.csv(), d3.json(), or d3.tsv(), we can load external data resources in the browser. These functions take the file path as an argument and load the data **asynchronously**. Once the data is loaded and the [Promise](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Using_promises) got resolved, you can work with the data.

Why do we need an asynchronous execution?
- The page should always be visible when data is loading in the background, and scripts that do not depend on the data should run immediately.
- Scripts that do depend on the data should only run once, when the data has been loaded.

Reading a file from the disk or an external server usually takes a while. Hence, we are using an asynchronous execution: We don't have to wait and stall, instead we can proceed with further tasks that do not rely on the dataset. After receiving a notification that the data loading process is complete, the callback function **then()** is executed.

**Code that depends on the dataset should generally exist only in the then() callback function!** You can (and often should) structure your code in separate functions, however, if these functions depend on the dataset, they should only be called inside the callback function).


```python
<!DOCTYPE html>
<html>
   <head>
      <script type = "text/javascript" src = "js/d3.v7.min.js"></script>
        <style>
            body { font-family: Arial; }
        </style>
   </head>

   <body>
        <div id = "svgcontainer"></div>

      <script>
        
        d3.csv('data/sandwiches.csv')
          .then(data => {
            console.log('Data loading complete. Work with dataset.');
            console.log(data);
          })
          .catch(error => {
            console.error('Error loading the data');
          });

        console.log('Do something else, without the data');

      </script>
   </body>
</html>
```

Run above code in your browser. Then open the console window. In Google Chrome, right-click then Inspect, then choose Console tab. An example of console displayed:

[![console](https://i.im.ge/2023/02/10/aPWqMP.console.png)](https://im.ge/i/aPWqMP)

You might have noticed that "Do something else, without the data" was printed first rather than the data. Because the callback function, the inner function of d3.csv(), is called only after the dataset has been fully loaded into browser memory. In the meantime other scripts are executed.

You might have noticed that each value of the CSV file is stored as a string, including numerical values. We need to convert all numerical values to numbers, or otherwise you will see unexpected behavior when making calculations.

We recommend iterating over all rows and using a statement similar to the following code snippet. Putting a "+" in front of a variable converts that variable to a number (you can also use parseInt() or parseFloat()).

`d.price = +d.price;`

Let's try to process the data stored in external data file.

We'll store the sandwich price information (from Modul 2 Latihan 1) in a CSV file. Very often, CSV files are generated by exporting data from other applications, but for this and many other examples in this course, our data is stored in a static CSV file.

Please download the sandwiches CSV file [here](https://drive.google.com/file/d/13gpWZtZp8hlAbMdSKN-C6QE1JhZiQoM8/view?usp=share_link). Then put in folder 'data'.


```python
<!DOCTYPE html>
<html>
   <head>
      <script type = "text/javascript" src = "js/d3.v7.min.js"></script>
   </head>

   <body>
        

    <script type="text/javascript">
    
    d3.csv('data/sandwiches.csv', d3.autoType).then(data => {
        console.log(data);

        d3.select("body")
            .selectAll("div")
            .data(data)
            .enter()
            .append("div")
            .text(d => { return "Name=" + d.name + ", Double Price=" +d.price*2; });
        });
  
    </script>


   </body>
</html>
```

Next we try to use json file for external data to draw SVG graph. The file can be downloaded from [here](https://drive.google.com/file/d/1Z_CT3t5pFktvKwJbAYdXYxrMsghlqaE0/view?usp=sharing). See example below.


```python
<!DOCTYPE html>
<html>
   <head>
      <script type = "text/javascript" src = "js/d3.v7.min.js"></script>
   </head>

   <body>
        <div id = "svgcontainer"></div>

<script type="text/javascript">
    
    d3.json('data/https://github.com/vvusk/lab-visdata/blob/496259e34a160c9a1ce55f9b699865a81e6ca50c/modul3/mydata.json', 
            d3.autoType)
        .then(data => {
        //console.log(data); //utk debug
        
        var width = 500;
        var height = 200;
        var svg = d3.select("#svgcontainer")
           .append("svg").attr("width", width).attr("height", height);
        
        svg.selectAll('rect')
            .data(data)
            .enter()
            .append('rect')
            .attr('fill', '#00AACD')
            .attr("width", d => { return d.age * 10; })
            .attr("height", 40)
            .attr("y", (d, i) => { return i * 50; })
            .attr('stroke', 'black');
        
        svg.selectAll('text')
            .data(data)
            .enter()
            .append('text')
            .attr("fill", "white")
            .attr("x", (d, i) => {return i + 5; })
            .attr("y", (d, i) => { return i * 50 + 24; })
            .text(d => { return d.name; })
            
        });
  
</script>

   </body>
</html>
```

### LATIHAN 1

1. Ubah latihan 1 yang ada pada Modul 2 dengan menggunakan external data yang dapat didownload di [sini](https://github.com/vvusk/lab-visdata/blob/26b8f8447da21df9460d9ceeb6934be4075b7584/modul3/sandwiches.csv).


### LATIHAN 2

Gunakan folder pada latihan sebelumnya. Anda hanya perlu membuat file yang baru untuk latihan ini.
- Download dataset di [sini](https://github.com/vvusk/lab-visdata/blob/401df2670b19274b58b45bcabdd8f481bd9cf81e/modul3/cities_and_population.csv)
- Gunakan D3 untuk membaca file CSV tersebut. Tes pembacaan data yang berhasil ke web console dan inspect di web browser. Lakukan pengecekan tipe data untuk variable pada file tersebut.
- Filter dataset menggunakan Javascript. Kita hanya akan menggunakan kota yang merupakan bagian dari Uni Eropa (European Union). Data yang sudah difilter itulah yang akan digunakan pada latihan ini. Cara untuk memfilter dapat dilihat di [sini](https://d3-graph-gallery.com/graph/basic_datamanipulation.html). Jangan lupa data yang sudah difilter disimpan kembali di data.
- Tambah satu paragraf ke dokumen HTML. Hitung semua data yang ada di dalam dataset yang sudah difilter dan gunakan Javascript atau D3 untuk menuliskan jumlah negara tersebut pada halaman web.
- Siapkan data, dengan mengubah nilai numerik ke number. 
- Gambar satu circle SVG untuk setiap baris yang ada pada dataset yang sudah di filter. 
    - Setiap unsur (drawing area + circle) dibuat secara dinamis dengan D3.
    - SVG container: width = 700px, height = 550px
    - Gunakan koordinat x/y pada dataset untuk memposisikan circle. 
- Buat property dari circle menjadi dinamis. Ubah radius sesuai dengan dataset.
    - Radius dibuat 4px untuk semua kota yang memiliki populasi lebih rendah dari 1.000.000
    - Radius dibuat 8px untuk semua kota dengan populasi lebih atau sama dengan 1.000.000
- Buatlah label nama untuk setiap kota di Uni Eropa.
    - Gunakan unsur SVG text
    - Setiap unsur haruslah memiliki class yang sama yaitu `city-label`
    - Label hanya akan muncul untuk kota dengan populasi lebih atau sama dengan 1.000.000. Anda bisa gunakan property `opacity` untuk menyelesaikan masalah ini.
- Styling
    - Buat stylesheet eksternal.
    - Masukkan style yang diperlukan pada halaman web dan pastikan anda membuat aturan CSS untuk class `city-label`:
        - ukuran font = 11px
        - text anchor = middle

Hasil tampilan dari latihan ini lebih kurang seperti gambar berikut.

[![exc2](https://i.im.ge/2023/02/19/7MirCa.exc2.md.png)](https://im.ge/i/7MirCa)

## Making a Chart

In this tutorial, you will learn how to create basic chart types, such as bar charts, scatter plots, and line charts. We will introduce the concept of input domains and output ranges which are the basis for D3 scales and needed in almost every visualization. We will also show you an object-oriented approach to make visualization components reusable.

### SVG groups

In the last tutorial, we created basic SVG shapes, like rectangles or circles, but there is another SVG element that is very useful for programming in D3: the group element (`<g></g>`). In contrast to graphical elements, the group element does not have a visual presence but it helps us to organize other elements and to apply *transformations*. In this way, we can create hierarchical structures.


```python
<!DOCTYPE html>
<html>
   <head>
      <script type = "text/javascript" src = "js/d3.v7.min.js"></script>
   </head>

   <body>
          
      <script>

        const w = 500;
        const h = 200;

        const svg = d3.select("body")
            .append("svg")
            .attr("width", w)
            .attr("height", h);

        // Create group element
        const group = svg.append('g');

        // Append circle to the group
        const circle = group.append('circle')
            .attr('r', 50)
            .attr('fill', 'blue');
         
      </script>
   </body>
</html>
```

Group elements are invisible but we can apply transformations, for example translate() or rotate(), to the group and it will affect the rendering of all child elements.

An example of translate process.

[![translate](https://i.im.ge/2023/02/19/aezMTS.translate.md.png)](https://im.ge/i/aezMTS)


```python
<!DOCTYPE html>
<html>
   <head>
      <script type = "text/javascript" src = "js/d3.v7.min.js"></script>
   </head>

   <body>
          
      <script>

        const w = 500;
        const h = 200;

        const svg = d3.select("body")
            .append("svg")
            .attr("width", w)
            .attr("height", h);

        // Group element with 'transform' attribute
        // x = 70, y = 50 (moves the whole group 70px to the right and 50px down)
        const group = svg.append("g")
            .attr("transform", "translate(70, 50)");

        // Append circle to the group
        const circle = group.append('circle')
            .attr('r', 50)
            .attr('fill', 'blue');
         
      </script>
   </body>
</html>
```

### Scales

Until now, we have only used x and y values that corresponded directly to pixel measurements on the screen, within a pre-defined SVG drawing area. That is not very flexible and only feasible for static data. What if our data attributes are suddenly doubled? We can not increase the size of the chart every time a value increases. At some point, the user might have to scroll through a simple bar chart to get all the information.

This is where scales come in. We specify a fixed SVG drawing space on our web page and scale the data to fit in the dedicated area.
- Scales are functions that map from an input domain to an output range.
- D3 provides built-in methods for many different scales: linear, ordinal, logarithmic, square root, and so on. Most of the time you will use linear scale functions, so we will focus on learning this type of scale.
- You can read more about D3 scales here: https://github.com/d3/d3-scale/blob/master/README.md

Example: We want to visualize the monthly sales of an ice cream store. The input data are numbers between 0 and 20,000 USD and the maximum height of the chart is 400px. We take an input inverval (called domain) and transform it into a new output interval (called range).

[![input-output](https://i.im.ge/2023/02/19/aezqUD.input-output.md.png)](https://im.ge/i/aezqUD)

We could transform the numbers from one domain into the other manually but what if the sales rise above 20.000 and the interval changes? That means a lot of manual work. Thankfully, we can use D3's built-in scaling methods to do this automatically.

D3 provides scale functions to convert the input domain to an output range. We can specify the domain and range by using method chaining syntax:


```python
#// Creating a linear scale function
const iceCreamScale = d3.scaleLinear()
    .domain([0, 20000])
    .range([0, 400]);

#// Call the function and pass an input value
iceCreamScale(5000);   // Returns: 100
```

This was pretty easy, because we already knew the max value of the data. What if we load data from an external source and don't know the data range the data is going to be in? Instead of specifying fixed values for the domain, we can use the convenient array functions `d3.min()`, `d3.max()` or `d3.extent()`.


```python
<!DOCTYPE html>
<html>
   <head>
      <script type = "text/javascript" src = "js/d3.v7.min.js"></script>
   </head>

   <body>
  
      <script>

        const quarterlyReport = [
            { month: 'May', sales: 6900 },
            { month: 'June', sales: 14240 },
            { month: 'July', sales: 25000 },
            { month: 'August', sales: 17500 }
        ];

        // Returns the maximum value in a given array (= 25000)
        const max = d3.max(quarterlyReport, d => d.sales);
        console.log(max);	//debug the result

        // Returns the minimum value in a given array (= 6900)
        const min = d3.min(quarterlyReport, d => d.sales);
        console.log(min);	//debug the result

        // Returns the min. and max. value in a given array (= [6900,25000])
        const extent = d3.extent(quarterlyReport, d => d.sales);
        console.log(extent);	//debug the result
            
      </script>
   </body>
</html>
```

#### Time scales
Time scales are a variant of linear scales that have a temporal domain. They require JS date objects.

#### Ordinal scales
D3 also provides methods to create ordinal scales with a discrete domain.

[![ordinal_scale_band](https://i.im.ge/2023/02/19/aenTdT.ordinal-scale-band.png)](https://im.ge/i/aenTdT)

For example, D3's ordinal scales can be very useful to simplify the positioning of bars in a bar chart, as you will see very soon.


```python
#// Create an ordinal scale function
const xScale = d3.scaleBand()
    .domain(['Vanilla', 'Cookies', 'Chocolate', 'Pistachio'])
    .range([0, 400])      // D3 fits n (=4) bands within a 400px space
    .paddingInner(0.05);  // Adds spacing between bands

#// By definition all bands have the same width
#// and you can get it with `xScale.bandwidth()`

#// We can use JS .map() instead of manually specifying all possible values
const months = quarterlyReport.map(d => d.month);
months // Returns: ['May', 'June', 'July', 'August']
```

#### Colour scales
D3 has built-in color palettes that work like ordinal scales and can also be accessed like other scales:

Examples:
- `d3.scaleOrdinal(d3.schemeCategory10)` - ordinal scale with a range of 10 categorical colours
- `d3.scaleOrdinal(d3.schemeCategory20)` - ordinal scale with a range of 20 categorical colours

We can then bind the colour scale to data values and render it:

[![color_scale_ordinal](https://i.im.ge/2023/02/19/ae4imL.color-scale-ordinal.png)](https://im.ge/i/ae4imL)


```python
#// Construct a new ordinal scale with a range of ten categorical colours
var colorPalette = d3.scaleOrdinal(d3.schemeCategory10);

#// We can log the color range and see 10 distinct hex colours
console.log(colorPalette.range());
#// ["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf"]

#// Specify domain (optional)
colorPalette.domain(['Vanilla', 'Cookies', 'Chocolate', 'Pistachio']);

#// Use color palette
colorPalette("Chocolate") // Returns: #2ca02c
```

Instead of using a fixed range of colours, you can use linear scale functions to create colour gradients:

[![color_scale_linear](https://i.im.ge/2023/02/19/ae40WG.color-scale-linear.png)](https://im.ge/i/ae40WG)


```python
const linearColor = d3.scaleLinear()
  .domain([0,100])
  .range(['lightgreen', 'darkgreen']);

linearColor(0) // Returns: #90ee90
```

Read more about [D3 colour scales](https://github.com/d3/d3-scale-chromatic/blob/master/README.md) or [other scale functions](https://github.com/d3/d3-scale), such as logarithmic or diverging scales.

### Axes

We typically need to add x- and y-axes to allow the user to extract meaningful insights from visualizations. An axis is the visual representation of a scale.

D3 provides four methods to create axes with different orientations and label placements (`d3.axisTop`, `d3.axisBottom`, `d3.axisLeft`, and `d3.axisRight`) which can display reference lines for D3 scales automatically. These axis components contain lines, labels, and ticks.


```python
#// Create a horizontal axis with labels placed below the axis
const xAxis = d3.axisBottom();

#// Pass in the scale function
xAxis.scale(xScale);

#//The above is equivalent to:
#//const xAxis = d3.axisBottom().scale(xScale);
```

Finally, to add the axis to the SVG, we need to specify the position in the DOM tree and then we have to call the axis function.

We create an SVG group element as a selection and use the call() function to hand it off to the axis function. All the axis elements are getting generated within that group.


```python
#// Draw the axis
svg.append('g')
    .attr('class', 'axis x-axis')
    .call(xAxis);
```

#### Refine the axis

D3 axis functions automatically adjust the spacing and labels for a given scale and range. Depending on the data and the type of the visualization, you may want to modify these settings.


```python
var xAxis = d3.axisBottom()
    .scale(xScale)
    . ... // Add options here
```

There are many different options to customize axes:
- Number of ticks: `.ticks(5)`
- Tick format, e.g. as percentage: `.tickFormat(d3.format(".0%"))`
- Predefined tick values: `.tickValues([0, 10, 20, 30, 40])`
- Remove tick marks at the beginning and end of an axis: `.tickSizeOuter(0)`

You can read more about D3 axis, ticks, and tick formatting in the [D3 documentation](https://github.com/d3/d3-axis/blob/master/README.md).

## Making a Bar Chart

Now, we know most of the concepts to create a D3 bar chart with a categorical y-axis and a linear x-axis. We'll be making the bar chart below using the quarterlyReport data from above.

[![bar-chart](https://i.im.ge/2023/02/19/aeBvrK.bar-chart.md.png)](https://im.ge/i/aeBvrK)

What we need to do:
- Download the empty template [project folder](https://drive.google.com/file/d/1yFRoKT5ihVnVKHwUBkxopGNEEDIzXzxy/view?usp=sharing). Or you can use your current working project.
- You can either source the quarterlyReport data from the Javascript array above, or download the equivalent .csv file from our [Github](https://github.com/vvusk/lab-visdata/blob/692020a045b8ff29de1f7a9fdfe2261f47a0677b/modul3/sales.csv).
- Add a `<div>` element in the `<body>` tag of `index.html` where we will add our svg chart.
- Use D3 to load the CSV file or Javascript array
- Prepare the data: Convert all numerical values to numbers.
- Append an empty svg and define its dimensions (width = 500, height = 120)
- Initialize your scales and axes Set and define:
    - xScale
    - yScale
    - xAxis
    - yAxis
- Draw your axes
- Draw the rectangles

Below are the code for `index.html` and `main.js`.


```python
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>D3 Bar Chart</title>
    <link rel="stylesheet" href="css/style.css">   <!--you can make an empty style.css-->
</head>
<body>
    <!-- We will add the SVG chart to the following container -->
    <div id="chart"></div>

    <script src="js/d3.v7.min.js"></script>
    <script src="js/main.js"></script>
</body>
</html>
```


```python
/*
 *  Load data from CSV file
 */
d3.csv('data/sales.csv')
    .then(data => {
        // Convert sales strings to numbers
        data.forEach(d => {
          d.sales = +d.sales;
        });

        showBarChart(data);
    })
    .catch(error => {
        console.error('Error loading the data');
    });

/*
 *  Draw chart
 */
function showBarChart(data) {
    const width = 500;
    const height = 120;

    // Append empty SVG container and set size
    const svg = d3.select('#chart').append('svg')
      .attr('width', width)
      .attr('height', height);

    // Initialize linear and ordinal scales (input domain and output range)
    const xScale = d3.scaleLinear()
      .domain([0, d3.max(data, d => d.sales)])
      .range([0, width]);

    const yScale = d3.scaleBand()
      .domain(data.map(d => d.month))
      .range([0, height])
      .paddingInner(0.1);

    // Initialize axes
    const xAxis = d3.axisBottom(xScale);
    const yAxis = d3.axisLeft(yScale);

    // Draw the axis
    const xAxisGroup = svg.append('g')
      .attr('class', 'axis x-axis')
      .call(xAxis);

    const yAxisGroup = svg.append('g')
      .attr('class', 'axis y-axis')
      .call(yAxis);

    // Add rectangles
    const bars = svg.selectAll('rect')
      .data(data)
      .enter()
    .append('rect')
      .attr('class', 'bar')
      .attr('fill', 'steelblue')
      .attr('width', d => xScale(d.sales))
      .attr('height', yScale.bandwidth())
      .attr('y', d => yScale(d.month))
      .attr('x', 0);
}
```

After running the code above, you probably get below image.

[![bar-chart1](https://i.im.ge/2023/02/19/aeejhP.bar-chart1.md.png)](https://im.ge/i/aeejhP)

The current chart does not look correct. We use `.axisBottom()` which places the tick labels below the x-axis but it is still shown at the top of the SVG area.

Recall that we can use the transform attribute to change the position and move the axis to the bottom, such as:


```python
const xAxisGroup = svg.append('g')
    .attr('class', 'axis x-axis')
    .attr('transform', `translate(0, ${height - margin})`)
    .call(xAxis);
```

Positioning the axes or defining the correct margins between components can be cumbersome. We recommend you to follow the *D3 Margin Convention* and to use a global margin object, with individual spacings for all directions.

### The D3 Margin Convention

"By convention, margins in D3 are specified as an object with top, right, bottom and left properties. Then, the outer size of the chart area, which includes the margins, is used to compute the inner size available for graphical marks by subtracting the margins." (Mike Bostock) [More detailed explanation](https://observablehq.com/@d3/margin-convention)

[![margin-convention](https://i.im.ge/2023/02/19/aeefKF.margin-convention.md.png)](https://im.ge/i/aeefKF)

#### Other chart refinements

We apply `.tickSizeOuter(0)` to remove tick marks at the beginning and end of an axis, and set the number of x-axis ticks with `.ticks(6)`. Additionally, we use CSS to adjust the style of the chart slightly. We now also specify the bar colour in CSS (css/style.css) because it is independent of the data. So please make a style.ccs file and insert below code into it.

`shape-rendering` is an SVG property which specifies how the SVG elements are getting rendered. We use `shape-rendering: crispEdges;` in this example to make sure that we don't get blurry axes and bars.


```python
.axis path,
.axis line {
    fill: none;
    stroke: #333;
    shape-rendering: crispEdges;
}

.axis text {
    font-family: sans-serif;
    font-size: 11px;
}

.bar {
    fill: steelblue;
    shape-rendering: crispEdges;
}
```

After that, replace the content of `showBarChart` function with below code.


```python
function showBarChart(data) {
    // Margin object with properties for the four directions
    const margin = {top: 5, right: 5, bottom: 20, left: 50};

    // Width and height as the inner dimensions of the chart area
    const width = 500 - margin.left - margin.right,
    height = 140 - margin.top - margin.bottom;

    // Define 'svg' as a child-element (g) from the drawing area and include spaces
    const svg = d3.select('#chart').append('svg')
        .attr('width', width + margin.left + margin.right)
        .attr('height', height + margin.top + margin.bottom)
        .append('g')
        .attr('transform', `translate(${margin.left}, ${margin.top})`);

    // All subsequent functions/properties can basically ignore the margins

    // Initialize linear and ordinal scales (input domain and output range)
    const xScale = d3.scaleLinear()
        .domain([0, d3.max(data, d => d.sales)])
        .range([0, width]);

    const yScale = d3.scaleBand()
        .domain(data.map(d => d.month))
        .range([0, height])
        .paddingInner(0.15);

    // Initialize axes
    const xAxis = d3.axisBottom(xScale)
        .ticks(6)
        .tickSizeOuter(0);

    const yAxis = d3.axisLeft(yScale)
        .tickSizeOuter(0);

    // Draw the axis (move xAxis to the bottom with 'translate')
    const xAxisGroup = svg.append('g')
        .attr('class', 'axis x-axis')
        .attr('transform', `translate(0, ${height})`)
        .call(xAxis);

    const yAxisGroup = svg.append('g')
        .attr('class', 'axis y-axis')
        .call(yAxis);

    // Add rectangles
    svg.selectAll('rect')
        .data(data)
        .enter()
      .append('rect')
        .attr('class', 'bar')
        .attr('width', d => xScale(d.sales))
        .attr('height', yScale.bandwidth())
        .attr('y', d => yScale(d.month))
        .attr('x', 0);
}
```

Now the resulting bar chart will look something like this.

[![bar-chart2](https://i.im.ge/2023/02/19/7MM60K.bar-chart2.md.png)](https://im.ge/i/7MM60K)

Sources:
- https://www.tutorialspoint.com/d3js/
- https://github.com/UBC-InfoVis/447-materials/tree/22Jan/tutorials/1_D3_Tutorial_Intro
- https://gist.github.com/akirap3/84e5d55c85b224466f44a35297d42a4b
